# 20.提示词的优化与迭代

真正成熟的 Prompt，从来不是“写出来的”，而是**调出来的**。

## 一、为什么一次写好 Prompt 几乎不可能

提示词工程本质上更像“实验科学”，而非“确定性编程”。由于LLM是非线性、非确定性、强上下文依赖，所以对表述极其敏感，有时候微小的词汇变化（甚至是一个空格）都可能引发不同的激活路径。加上由于长尾效应和不同的模型差异，同一个提示词经常有不同的表现。

所以提示词调优的第一步，不是随便改，而是给失败分类。即在 Debug 之前，你得先知道 AI 是怎么“失败”的。

## 二、常见失败模式

以下是五种最典型的失败模式：

1. **逻辑跑偏 (Drift)：** AI 聊着聊着忘记了最初的约束，或者被用户中间的一句话带节奏。
2. **幻觉编造 (Hallucination)：** 在知识盲区强行输出，一本正经地胡说八道。
3. **过度发散 (Verbosity)：** 给它的指令是“简洁”，它却回了你五段文字。
4. **指令冲突 (Instruction Conflict)：** 当你要求“输出 JSON”同时又要求“加上详细解释”时，AI 往往会顾此失彼。
5. **格式崩坏 (Format Collapse)：** 结构化输出中途断掉，或者出现了无法解析的非法字符。

## 三、Prompt 迭代的基本流程

Prompt 的开发不应是盲目修改，而应遵循类似软件开发的**测试驱动（TDD）** 流程。

### 1. 退化分析 (Regression Analysis)

当你修改 Prompt 解决了一个 Bug 后，必须检查**是否引入了新的 Bug**。

* *例子：* 为了让 AI 说话更客气，你修改了提示词，结果发现它原本强大的逻辑推理能力因为“废话变多”而退化了。

### 2. Prompt A/B 测试

同时运行两个版本的 Prompt，针对同一组数据进行对比。

* **版本 A：** 强调逻辑步骤。
* **版本 B：** 强调输出格式。
  通过对比成功率、Token 消耗和用户满意度来定稿。

### 3.Prompt 回归测试集

回归测试集是一组**代表真实复杂度**的输入集合，通常包括正常样本、极端样本、易错样本、边界样本。它可以防止旧问题复发、防止局部优化导致整体崩盘、量化 Prompt 演化。

### 4.温度 (Temperature) 与 Top-P 的配合

在调优时，不仅要改文字，还要调参数。

- **Temperature (0-2)：** 控制随机性。

- *任务型（JSON/提取）：* 建议设为 **0**。

- *创意型（写诗/文案）：* 建议设为 **0.7 - 1.0**。

- **Top-P：** 另一种控制多样性的手段。通常建议只调整其中一个，不要两者同时大幅改动。

### 5. 示例

假设一个需求是从合同文本中**抽取金额和日期，并稳定输出为可解析 JSON**，用于后续入库。

**初版 Prompt（失败案例）**

> “帮我把这段合同里的金额和日期找出来，给个 JSON。”

这个提示词通常会有以下表现：

- 经常输出：
  
  > 好的，下面是提取结果：  
  > `{ ... }`

- 日期格式混乱：
  
  - `2024年1月3日`
  
  - `01/03/2024`
  
  - `January 3, 2024`

- 有时还会附带解释性文字，导致程序 JSON.parse 直接报错。

这导致的后果是**链路不稳定，无法自动化。**

**调优过程**

1. 失败识别

先定位识别模式为格式崩坏、过度发散、潜在幻觉风险（信息缺失时乱填），并明确这是一个**结构强约束 + 低随机性**任务。

2. 引入 Schema 约束

把“给个 JSON”升级为**程序接口定义**：

```text
请严格按照以下 JSON Schema 输出：

{
  "amount": number | null,
  "date": "YYYY-MM-DD" | null
}
```

并补充说明：

- 所有字段必须出现

- 不允许新增字段
3. 增加负向约束

显式禁止模型最常见的破坏行为：

```text
- Do NOT include explanations.
- Do NOT include markdown.
- Do NOT include conversational text.
- Output JSON only.
```

4. 尝试 Few-shot

真实问题往往卡在“边界格式”。

比如合同中常见: 二零二四年一月本合同于签署之日，生效金额以人民币叁拾万元整为准

加入一条**复杂示例**：

```text
示例：
输入：本合同签订于二零二四年一月，金额为叁拾万元。
输出：
{
  "amount": 300000,
  "date": "2024-01-01"
}
```

5.参数收敛（降低不确定性）

通过调整参数降低不确定性，比如将Temperature → 0、Top-p → 默认或较低。

一个良好的 Prompt 有以下特征

- 有明确 Schema

- 有失败兜底（null）

- 有负向约束

- 有边界示例

- 有参数配合

此时 Prompt 才第一次具备**上线资格**。

在上线前还要做以下检查：

a. 重点是否足够突出？

- 最关键约束（格式 / 角色 / 目标）是否放在 Prompt 结尾？

- 是否存在多个“第一优先级”？

b.输入边界是否清晰？

- 是否用 `###` / `"""` / `---` 明确隔离指令与数据？

- 是否避免模型把“合同文本”当成“新指令”？

c.是否设计了失败出口？

- 是否允许返回 `null / unknown / insufficient`？

- 是否明确禁止编造？

d.是否经过回归测试？

- 老的失败样本还会不会挂？

- 新 Prompt 是否引入新崩点？

- JSON 是否 100% 可解析？

e.参数是否与任务匹配？

- 结构任务是否收敛（Temp≈0）

- 创意任务是否放开

- 是否乱调多个随机参数
